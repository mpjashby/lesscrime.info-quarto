<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Matt Ashby">
<meta name="dcterms.date" content="2019-08-30">
<meta name="description" content="UK Office for National Statistics data can be in formats that are hard to analyse. This tutorial works through how to clean ONS data tables.">

<title>Tutorial: Cleaning UK Office for National Statistics data in R – Matt Ashby</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-ee5d4d5833c2e32a258b66c087c6b3f6.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Matt Ashby</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../post/index.html"> 
<span class="menu-text">Blog posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publication/index.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../talk/index.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../cv/index.pdf"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../crimpapers/"> 
<span class="menu-text">CrimPapers</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#why-do-this" id="toc-why-do-this" class="nav-link active" data-scroll-target="#why-do-this">Why do this?</a></li>
  <li><a href="#before-you-start" id="toc-before-you-start" class="nav-link" data-scroll-target="#before-you-start">Before you start</a></li>
  <li><a href="#download" id="toc-download" class="nav-link" data-scroll-target="#download">Download the data</a></li>
  <li><a href="#load" id="toc-load" class="nav-link" data-scroll-target="#load">Load the data into R</a></li>
  <li><a href="#clean" id="toc-clean" class="nav-link" data-scroll-target="#clean">Clean the data</a></li>
  <li><a href="#complete" id="toc-complete" class="nav-link" data-scroll-target="#complete">A complete script</a></li>
  <li><a href="#tips" id="toc-tips" class="nav-link" data-scroll-target="#tips">Tips for other ONS tables</a>
  <ul class="collapse">
  <li><a href="#missing-values-in-the-data" id="toc-missing-values-in-the-data" class="nav-link" data-scroll-target="#missing-values-in-the-data">Missing values in the data</a></li>
  <li><a href="#multiple-tables-in-a-single-sheet" id="toc-multiple-tables-in-a-single-sheet" class="nav-link" data-scroll-target="#multiple-tables-in-a-single-sheet">Multiple tables in a single sheet</a></li>
  <li><a href="#category-names-or-values-with-footnote-markers" id="toc-category-names-or-values-with-footnote-markers" class="nav-link" data-scroll-target="#category-names-or-values-with-footnote-markers">Category names or values with footnote markers</a></li>
  <li><a href="#dates-and-date-ranges-stored-as-text" id="toc-dates-and-date-ranges-stored-as-text" class="nav-link" data-scroll-target="#dates-and-date-ranges-stored-as-text">Dates and date ranges stored as text</a></li>
  <li><a href="#r-session-information" id="toc-r-session-information" class="nav-link" data-scroll-target="#r-session-information">R session information</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Tutorial: Cleaning UK Office for National Statistics data in R</h1>
</div>

<div>
  <div class="description">
    UK Office for National Statistics data can be in formats that are hard to analyse. This tutorial works through how to clean ONS data tables.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Matt Ashby </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">30 Aug 2019</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>TL; DR: <a href="#complete">skip to the complete script</a></p>
<p>The UK <a href="https://ons.gov.uk/">Office for National Statistics</a> (ONS) publishes a lot of quantitative information on all the topics you’d expect from a national statistical office, but most of it is released in formats that need manual cleaning before they can be used for data analysis.</p>
<p><a href="">ONS has started publishing some machine-readable data</a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, but most products its produces are Excel tables that are optimised for human reading by mimicking the format of tables in the printed statistical reports that ONS produced for decades.</p>
<p>This tutorial talks through how to clean a human-readable table produced by ONS using the <code>tidyverse</code> collection of packages, so the resulting <a href="http://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html">tidy data</a> can be used for analysis. As an example, we’ll use a file containing <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/populationestimatesforukenglandandwalesscotlandandnorthernireland">population estimates for each nation within the United Kingdom</a> by five-year age groups.</p>
<section id="why-do-this" class="level1">
<h1>Why do this?</h1>
<p>It might be tempting not to clean the data in R but instead simply open the relevant file in Excel and make the necessary changes there. This will work, but there are at least three reasons why cleaning the data in Excel is not necessarily a good idea.</p>
<ul>
<li><em>It’s harder to repeat the process</em>. For example, if ONS updates the table (either because new data is available or to correct a problem) then you have to repeat the manual process in Excel. If you clean the data in R, typically all you have to do is run the script again.</li>
<li><em>It’s harder to find mistakes</em>. If you make a mistake while changing data in Excel but don’t notice until later (e.g.&nbsp;if your results don’t make sense) it will be difficult to track down exactly what happened. If you use a script to clean the data, you can go back and run it line-by-line to identify the problem.</li>
<li><em>It’s harder for others to trust your work</em>. If someone else wants to check your analysis (e.g.&nbsp;before taking action based on it), that’s more difficult if you have manipulated the data manually in ways the other person cannot see.</li>
</ul>
</section>
<section id="before-you-start" class="level1">
<h1>Before you start</h1>
<p>This tutorial assumes you have <a href="https://cloud.r-project.org">R</a> installed and that you’re comfortable with the basics of <a href="https://www.computerworld.com/article/2497143/business-intelligence-beginner-s-guide-to-r-introduction.html">using R to manipulate data</a>. If you don’t have the tidyverse collection of packages installed already, run <code>install.packages("tidyverse")</code> before continuing. It also a good idea to run this code from <a href="https://www.tidyverse.org/articles/2017/12/workflow-vs-script/">inside a project</a>.</p>
</section>
<section id="download" class="level1">
<h1>Download the data</h1>
<p>Although ONS is relatively good at providing archive data, it’s good practice to always save an unamended copy of the raw data for any project just in case it later disappears from the source website.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># download the data file</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">url =</span> <span class="st">"https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/populationestimatesforukenglandandwalesscotlandandnorthernireland/mid20182019laboundaries/ukmidyearestimates20182019ladcodes.xls"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">destfile =</span> <span class="st">"ons_pop_data.xls"</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load" class="level1">
<h1>Load the data into R</h1>
<p>Since the data are in an Excel file, we can use the <a href="https://readxl.tidyverse.org"><code>readxl</code></a> package to read it into R<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. ONS publishes data using a mixture of file formats, including both the pre-2007 Excel <code>.xls</code> file format and the current <code>.xlsx</code> format<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. The <code>read_excel()</code> function can handle both <code>.xls</code> and <code>.xlsx</code> files, but can only load a single sheet from within an Excel workbook (i.e.&nbsp; file). We can use the <code>excel_sheets()</code> function to get the names of each sheet in the Excel file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"readxl"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tidyverse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.1     ✔ tibble    3.2.1
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.0.4     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">excel_sheets</span>(<span class="st">"ons_pop_data.xls"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Contents "                  "Terms and conditions "     
 [3] "Notes and definitions"      "Admin. geography hierarchy"
 [5] "MYE1"                       "MYE2-All"                  
 [7] "MYE2 - Males"               "MYE2 - Females"            
 [9] "MYE3"                       "MYE4 "                     
[11] "MYE 5"                      "MYE 6"                     
[13] "Related publications"      </code></pre>
</div>
</div>
<p>Note that some of the sheets have a space at the end of the name, which will be invisible when viewing the file in Excel but which we need to know about to specify the sheet name for <code>read_excel()</code>.</p>
<p>The <code>Contents</code> sheet contains a short description of the data in each of the other sheets. There are blank rows between every row in this table (an example of how ONS optimises for human rather than computer readability), but we can remove these rows using the <code>drop_na()</code> function from the <code>tidyr</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">drop_na</span>(<span class="fu">read_excel</span>(<span class="st">"ons_pop_data.xls"</span>, <span class="at">sheet =</span> <span class="st">"Contents "</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 2
   Contents                   Population Estimates for UK, England and Wales, …¹
   &lt;chr&gt;                      &lt;chr&gt;                                             
 1 Terms and conditions       Terms and conditions                              
 2 Notes and definitions      Notes and definitions                             
 3 Admin. geography hierarchy Administrative geography hierarchy for the United…
 4 MYE1                       Population estimates: Summary for the UK, mid-2018
 5 MYE2 - All                 Population estimates: Persons by single year of a…
 6 MYE2 - M                   Population estimates: Males by single year of age…
 7 MYE2 - F                   Population estimates: Females by single year of a…
 8 MYE3                       Components of population change for local authori…
 9 MYE4                       Population estimates: Summary for the UK, mid-197…
10 MYE5                       Population estimates: Population density for loca…
11 MYE6                       Median age of population for local authorities in…
12 Related publications       Provides links to further population statistics &amp;…
# ℹ abbreviated name:
#   ¹​`Population Estimates for UK, England and Wales, Scotland and Northern Ireland: Mid-2018, using April 2019 local authority district codes`</code></pre>
</div>
</div>
<p>We’re going to use the data from the mid-2018 UK population summary, so we want the <code>MYE1</code> sheet. We can now use <code>read_excel()</code> to load the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>file_data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">"ons_pop_data.xls"</span>, <span class="at">sheet =</span> <span class="st">"MYE1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `` -&gt; `...2`
• `` -&gt; `...3`
• `` -&gt; `...4`
• `` -&gt; `...5`
• `` -&gt; `...6`
• `` -&gt; `...7`
• `` -&gt; `...8`
• `` -&gt; `...9`</code></pre>
</div>
</div>
</section>
<section id="clean" class="level1">
<h1>Clean the data</h1>
<p>In Excel, the <code>MYE1</code> sheet looks like this:</p>
<p><img src="../../post/cleaning-ons-data/mye1-sheet-preview.png" class="img-fluid"></p>
<p>The <code>file_data</code> object contains the result of the <code>read_excel()</code> function’s attempt to load this sheet into R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>file_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 33 × 9
   Contents                      ...2  ...3  ...4  ...5  ...6  ...7  ...8  ...9 
   &lt;chr&gt;                         &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
 1 &lt;NA&gt;                          &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt; &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;
 2 MYE1: Population estimates: … &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  "Ple… This… I ne… "Thi…
 3 &lt;NA&gt;                          &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt; &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;
 4 Country / Code                K020… K030… K040… E920… "W92… S920… N920…  &lt;NA&gt;
 5 &lt;NA&gt;                          UNIT… GREA… ENGL… ENGL… "WAL… SCOT… NORT…  &lt;NA&gt;
 6 &lt;NA&gt;                          &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt; &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;
 7 All Persons                   6643… 6455… 5911… 5597… "313… 5438… 1881…  &lt;NA&gt;
 8 Males                         3279… 3186… 2921… 2766… "154… 2648… 9262…  &lt;NA&gt;
 9 Females                       3364… 3268… 2990… 2830… "159… 2789… 9554…  &lt;NA&gt;
10 &lt;NA&gt;                          &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt; &lt;NA&gt;  &lt;NA&gt;   &lt;NA&gt;
# ℹ 23 more rows</code></pre>
</div>
</div>
<p>This isn’t very useful. There are several problems we need to fix:</p>
<ol type="1">
<li>the column names don’t reflect the data in each column,</li>
<li>all the columns have the type <code>&lt;chr&gt;</code> (character) even when the columns contain numbers,</li>
<li>there are several blank or partially blank rows,</li>
<li>the feedback questionnaire in the top-left corner of the sheet means <code>file_data</code> contains an extra column,</li>
<li>there is a row containing a footnote,</li>
<li>the data are in wide rather than long format.</li>
</ol>
<p>We can fix all of these either using the parameters of <code>read_excel()</code> or<br>
functions from the tidyverse packages.</p>
<p>We can exclude all the cells in the sheet except those containing data with the <code>range =</code> parameter of <code>read_excel()</code>. We can either specify the cell range manually (e.g.&nbsp;<code>range = "A5:H31"</code>) or we can use one of the <code>cell_*</code> collection of helper functions from the <code>cellranger</code> package, which is loaded with <code>readxl</code>.</p>
<p>We can work out which cells we want to retain either by opening the file in Excel and noting which rows contain the data, or by running <code>View(file_data)</code> in R and then adjusting the value of <code>range =</code> in <code>read_excel()</code> until we are happy with the result.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>file_data <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">"ons_pop_data.xls"</span>,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">sheet =</span> <span class="st">"MYE1"</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">range =</span> <span class="fu">cell_rows</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">31</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>file_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 26 × 8
   `Country / Code` K02000001  K03000001 K04000001 E92000001 W92000004 S92000003
   &lt;chr&gt;            &lt;chr&gt;      &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;    
 1 &lt;NA&gt;             UNITED KI… GREAT BR… ENGLAND … ENGLAND   WALES     SCOTLAND 
 2 &lt;NA&gt;             &lt;NA&gt;       &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;     
 3 All Persons      66435550   64553909  59115809  55977178  3138631   5438100  
 4 Males            32790202   31864002  29215251  27667942  1547309   2648751  
 5 Females          33645348   32689907  29900558  28309236  1591322   2789349  
 6 &lt;NA&gt;             &lt;NA&gt;       &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;     
 7 Age Groups       &lt;NA&gt;       &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt;     
 8 0-4              3914028    3792292   3515430   3346727   168703    276862   
 9 5-9              4138524    4009409   3708320   3523866   184454    301089   
10 10-14            3858894    3738572   3450782   3274119   176663    287790   
# ℹ 16 more rows
# ℹ 1 more variable: N92000002 &lt;chr&gt;</code></pre>
</div>
</div>
<p>This deals with the unwanted rows above and below the table, as well as the unwanted columns produced because of the feedback questionnaire.</p>
<p>The next problem is that the column names represent the <a href="https://webarchive.nationalarchives.gov.uk/20160106185615/http://www.ons.gov.uk/ons/guide-method/geography/beginner-s-guide/index.html">GSS statistical codes</a> for the different nations of the UK, rather than the names of the nations. You may prefer the codes, but we’ll assume that you want the names.</p>
<p>We can use functions from the <code>magrittr</code> package to work with individual values in the data. All these functions are aliases for base R functions, but can be easier to work with.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"magrittr"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set a value for the first row in the first column, which is currently blank</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>file_data[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"group"</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># replace the existing column names with the values from the first row</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>file_data <span class="ot">&lt;-</span> <span class="fu">set_colnames</span>(file_data, file_data[<span class="dv">1</span>, ])</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># remove the first row, which we no longer need, using slice() from dplyr</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>file_data <span class="ot">&lt;-</span> <span class="fu">slice</span>(file_data, <span class="dv">2</span><span class="sc">:</span><span class="fu">n</span>())</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>file_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 25 × 8
   group      `UNITED KINGDOM` `GREAT BRITAIN` `ENGLAND AND WALES` ENGLAND WALES
   &lt;chr&gt;      &lt;chr&gt;            &lt;chr&gt;           &lt;chr&gt;               &lt;chr&gt;   &lt;chr&gt;
 1 &lt;NA&gt;       &lt;NA&gt;             &lt;NA&gt;            &lt;NA&gt;                &lt;NA&gt;    &lt;NA&gt; 
 2 All Perso… 66435550         64553909        59115809            559771… 3138…
 3 Males      32790202         31864002        29215251            276679… 1547…
 4 Females    33645348         32689907        29900558            283092… 1591…
 5 &lt;NA&gt;       &lt;NA&gt;             &lt;NA&gt;            &lt;NA&gt;                &lt;NA&gt;    &lt;NA&gt; 
 6 Age Groups &lt;NA&gt;             &lt;NA&gt;            &lt;NA&gt;                &lt;NA&gt;    &lt;NA&gt; 
 7 0-4        3914028          3792292         3515430             3346727 1687…
 8 5-9        4138524          4009409         3708320             3523866 1844…
 9 10-14      3858894          3738572         3450782             3274119 1766…
10 15-19      3669250          3555359         3270795             3096575 1742…
# ℹ 15 more rows
# ℹ 2 more variables: SCOTLAND &lt;chr&gt;, `NORTHERN IRELAND` &lt;chr&gt;</code></pre>
</div>
</div>
<p>Next we remove any rows containing empty cells, since none of the data rows contain empty cells (see <a href="#tips">Tips</a>, below, for tables where this isn’t the case).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>file_data <span class="ot">&lt;-</span> <span class="fu">drop_na</span>(file_data)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>file_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 22 × 8
   group      `UNITED KINGDOM` `GREAT BRITAIN` `ENGLAND AND WALES` ENGLAND WALES
   &lt;chr&gt;      &lt;chr&gt;            &lt;chr&gt;           &lt;chr&gt;               &lt;chr&gt;   &lt;chr&gt;
 1 All Perso… 66435550         64553909        59115809            559771… 3138…
 2 Males      32790202         31864002        29215251            276679… 1547…
 3 Females    33645348         32689907        29900558            283092… 1591…
 4 0-4        3914028          3792292         3515430             3346727 1687…
 5 5-9        4138524          4009409         3708320             3523866 1844…
 6 10-14      3858894          3738572         3450782             3274119 1766…
 7 15-19      3669250          3555359         3270795             3096575 1742…
 8 20-24      4184575          4068584         3717960             3512654 2053…
 9 25-29      4527175          4404612         4022272             3815924 2063…
10 30-34      4463357          4337288         3976030             3787597 1884…
# ℹ 12 more rows
# ℹ 2 more variables: SCOTLAND &lt;chr&gt;, `NORTHERN IRELAND` &lt;chr&gt;</code></pre>
</div>
</div>
<p>We can convert the data from wide to long using <code>gather()</code> from the <code>tidyr</code> package. <code>gather()</code> can be a slightly confusing function to use, but there are some useful tutorials available by <a href="https://garrettgman.github.io/tidying/#gather">Garrett Grolemund</a>, <a href="https://uc-r.github.io/tidyr#gather--function">UC Business Analytics</a> and <a href="https://r4ds.had.co.nz/tidy-data.html#spreading-and-gathering">R for Data Science</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>file_data <span class="ot">&lt;-</span> <span class="fu">gather</span>(file_data, <span class="at">key =</span> <span class="st">"geography"</span>, <span class="at">value =</span> <span class="st">"population"</span>, <span class="sc">-</span>group)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>file_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 154 × 3
   group       geography      population
   &lt;chr&gt;       &lt;chr&gt;          &lt;chr&gt;     
 1 All Persons UNITED KINGDOM 66435550  
 2 Males       UNITED KINGDOM 32790202  
 3 Females     UNITED KINGDOM 33645348  
 4 0-4         UNITED KINGDOM 3914028   
 5 5-9         UNITED KINGDOM 4138524   
 6 10-14       UNITED KINGDOM 3858894   
 7 15-19       UNITED KINGDOM 3669250   
 8 20-24       UNITED KINGDOM 4184575   
 9 25-29       UNITED KINGDOM 4527175   
10 30-34       UNITED KINGDOM 4463357   
# ℹ 144 more rows</code></pre>
</div>
</div>
<p>Finally, we will neaten the data by converting the population variable to numeric and the geography variable to title case (using a function from the <code>stringr</code> package).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>tidy_data <span class="ot">&lt;-</span> <span class="fu">mutate</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  file_data,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">geography =</span> <span class="fu">str_to_title</span>(geography),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">population =</span> <span class="fu">as.numeric</span>(population)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>tidy_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 154 × 3
   group       geography      population
   &lt;chr&gt;       &lt;chr&gt;               &lt;dbl&gt;
 1 All Persons United Kingdom   66435550
 2 Males       United Kingdom   32790202
 3 Females     United Kingdom   33645348
 4 0-4         United Kingdom    3914028
 5 5-9         United Kingdom    4138524
 6 10-14       United Kingdom    3858894
 7 15-19       United Kingdom    3669250
 8 20-24       United Kingdom    4184575
 9 25-29       United Kingdom    4527175
10 30-34       United Kingdom    4463357
# ℹ 144 more rows</code></pre>
</div>
</div>
</section>
<section id="complete" class="level1">
<h1>A complete script</h1>
<p>Using the <a href="https://cran.r-project.org/package=magrittr/vignettes/magrittr.html"><code>magrittr</code> pipe <code>%&gt;%</code></a>, we can combine all these cleaning steps together, which makes the code more compact and (arguably) more readable.</p>
<pre><code>library("lubridate") # lubridate and magrittr are part of the
library("magrittr") # tidyverse but not loaded with it by default
library("readxl")
library("tidyverse")

tidy_data &lt;- read_excel("ons_pop_data.xls",
  sheet = "MYE1",
  range = cell_rows(5:31)
) %&gt;%
  inset(1, 1, "group") %&gt;%
  set_colnames(.[1, ]) %&gt;%
  slice(2:n()) %&gt;%
  drop_na() %&gt;%
  gather(key = "geography", value = "population", -group) %&gt;%
  mutate(
    geography = str_to_title(geography),
    population = as.numeric(population)
  )
</code></pre>
</section>
<section id="tips" class="level1">
<h1>Tips for other ONS tables</h1>
<p>There is a huge number of ONS tables available, some having different formatting issues from those mentioned above. These are some of the issues I’ve come across and potential ways to deal with them.</p>
<p>(The examples below all assume your data is in a data frame/tibble called <code>data</code>.)</p>
<section id="missing-values-in-the-data" class="level2">
<h2 class="anchored" data-anchor-id="missing-values-in-the-data">Missing values in the data</h2>
<p>Many ONS datasets have missing values, and some even have multiple values representing different reasons for the values being missing. For example, data for small geographic areas might be missing because the data could not be collected for a particular location or have been redacted to prevent disclosure of personal information.</p>
<p>The <code>na =</code> parameter of <code>read_excel()</code> can be used to specify values in the data that should be treated as missing. For example, if an ONS table uses a blank cell to represent data that could not be collected and <code>**</code> to represent redacted data, <code>read_excel("data.xlsx", sheet = "Sheet 1", na = c("", "**"))</code> will ensure both values are represented by <code>NA</code> in R.</p>
<p>It isn’t possible to use <code>drop_na()</code> to remove empty rows if there are missing values in the data, because <code>drop_na()</code> removes rows that contain <em>any</em> missing values. Instead, you can use <code>remove_empty()</code> from the <code>janitor</code> package to remove rows or columns that are entirely empty. If there are rows that you want to remove from the data that contain some missing values and some values that are not missing, use <code>filter()</code> from <code>dplyr</code> based on the value of a specific column. For example, to remove rows with the value of <code>population</code> missing, use <code>filter(data, !is.na(population))</code>. To remove single rows manually by row number, use <code>slice()</code>, also from <code>dplyr</code>.</p>
</section>
<section id="multiple-tables-in-a-single-sheet" class="level2">
<h2 class="anchored" data-anchor-id="multiple-tables-in-a-single-sheet">Multiple tables in a single sheet</h2>
<p>Sometimes multiple related data tables are placed on a single Excel sheet. You can either import them separately and then combine the resulting datasets manually (e.g.&nbsp;with <code>rbind()</code>) or just treat the rows or columns between each table as clutter that can be removed using a combination of <code>drop_na()</code> and <code>slice()</code> as above. In the latter case, modify the <code>range =</code> argument of <code>read_excel()</code> so that the selected cells/rows/columns include all the tables.</p>
</section>
<section id="category-names-or-values-with-footnote-markers" class="level2">
<h2 class="anchored" data-anchor-id="category-names-or-values-with-footnote-markers">Category names or values with footnote markers</h2>
<p>If tables have multiple footnotes, some categories or values may end in a footnote marker (typically a number). To remove these, use <code>str_remove()</code> from <code>stringr</code>. For example, if the column <code>place</code> contains values with footnote markers, you can use <code>mutate(data, place = str_remove(place, "\\d+$"))</code> to remove them, where <code>\\d+</code> is a <a href="https://stringr.tidyverse.org/articles/regular-expressions.html#matching-multiple-characters">regular expression that matches one or more numeric characters</a> and <a href="https://stringr.tidyverse.org/articles/regular-expressions.html#anchors"><code>$</code> matches only numeric characters at the end of the value</a> of <code>place</code>. This only works for non-numeric values with numeric footnote markers, since the regular expression <code>\\d+$</code> will match any sequence of numbers at the end of a cell.</p>
</section>
<section id="dates-and-date-ranges-stored-as-text" class="level2">
<h2 class="anchored" data-anchor-id="dates-and-date-ranges-stored-as-text">Dates and date ranges stored as text</h2>
<p>Since many ONS statistics are published for financial years, time periods are often stored as strings showing, for example, <code>2018-19</code>. Converting these to dates helps with things like plotting values on an axis with date values or using the data in a time-series model.</p>
<p>The <code>lubridate</code> package is very useful for converting dates. You can either represent each date as a specific moment in time, or as an interval in time. For example, if a financial year is stored as <code>2018-19</code> in the <code>year</code> column, you can extract the specific moment the year started using <code>mutate(year_beginning = ymd(paste(str_sub(year, 0, 4)), "04", "01"))</code>. In this code, <code>str_sub(year, 0, 4)</code> extracts the first four characters from the string <code>2018-19</code>, <code>paste()</code> creates a single character value for 1 April in the given year (e.g.&nbsp;<code>2018 04 01</code>) and <code>ymd()</code> converts that string into a date object.</p>
<p>To store a date as an interval, we extract both the date on which the year started and the date it ended. For example,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  data,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">year_interval =</span> <span class="fu">interval</span>(</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ymd</span>(<span class="fu">paste</span>(<span class="fu">str_sub</span>(year, <span class="dv">0</span>, <span class="dv">4</span>), <span class="st">"04"</span>, <span class="st">"01"</span>)),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ymd</span>(<span class="fu">paste</span>(<span class="fu">str_sub</span>(year, <span class="sc">-</span><span class="dv">2</span>), <span class="st">"03"</span>, <span class="st">"31"</span>))</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="r-session-information" class="level2">
<h2 class="anchored" data-anchor-id="r-session-information">R session information</h2>
<p>The code in this tutorial was run in R with the following configuration:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.2 (2024-10-31)
Platform: aarch64-apple-darwin20
Running under: macOS Sequoia 15.4.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] magrittr_2.0.3  lubridate_1.9.4 forcats_1.0.0   stringr_1.5.1  
 [5] dplyr_1.1.4     purrr_1.0.4     readr_2.1.5     tidyr_1.3.1    
 [9] tibble_3.2.1    ggplot2_3.5.1   tidyverse_2.0.0 readxl_1.4.3   

loaded via a namespace (and not attached):
 [1] gtable_0.3.6      jsonlite_2.0.0    compiler_4.4.2    tidyselect_1.2.1 
 [5] scales_1.3.0      yaml_2.3.10       fastmap_1.2.0     R6_2.6.1         
 [9] generics_0.1.3    knitr_1.49        htmlwidgets_1.6.4 munsell_0.5.1    
[13] pillar_1.10.1     tzdb_0.5.0        rlang_1.1.5       utf8_1.2.4       
[17] stringi_1.8.7     xfun_0.51         timechange_0.3.0  cli_3.6.4        
[21] withr_3.0.2       digest_0.6.37     grid_4.4.2        rstudioapi_0.17.1
[25] hms_1.1.3         lifecycle_1.0.4   vctrs_0.6.5       evaluate_1.0.3   
[29] glue_1.8.0        cellranger_1.1.0  colorspace_2.1-1  rmarkdown_2.29   
[33] tools_4.4.2       pkgconfig_2.0.3   htmltools_0.5.8.1</code></pre>
</div>
</div>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>ONS refers to this as ‘open data’, although (almost) all the products it produces are already <a href="https://www.ons.gov.uk/methodology/geography/licences">open licensed under the Open Government Licence</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The <code>readxl</code> package is <a href="https://www.tidyverse.org/packages/">installed as part of the tidyverse</a> but is not automatically loaded by <code>library("tidyverse")</code>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>I have not been able to work out why some ONS files are in <code>.xls</code> format and some in <code>.xlsx</code>.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>The content on this website is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution Licence</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>