{"title":"Chart: Drug use was falling, but that seems to be changing","markdown":{"yaml":{"title":"Chart: Drug use was falling, but that seems to be changing","author":"Matt Ashby","date":"2019-09-23","categories":["Crime and justice chart of the week"],"tags":["crime","CSEW","drugs"]},"headingText":"custom packages not loaded by helpers.R","containsRefs":false,"markdown":"\n\n```{r set knitr options, include=FALSE}\nknitr::opts_chunk$set(cache = TRUE, include=FALSE)\n```\n\n```{r load packages and helper}\nlibrary(\"lubridate\")\nlibrary(\"readxl\")\n\n# load this after loading custom packages\nsource(here::here(\"helpers.R\"))\n```\n\n```{r set chart parameters}\nchart_details <- list(\n\tid = \"drug-use\",\n\ttitle = \"After falls, drug use by young adults is on the rise\",\n\tsubtitle = \"Self-reported drug use has fallen for most of the past 20 years according to the Crime Survey for England and Wales, but in the past seven years the use of cannabis, cocaine and ecstasy has increased substantially, particularly among people aged 16–24. However, drug use is still lower now than it was at the turn of the millenium, with about 10% of adults saying they've used an illegal drug in the past year.\",\n\tsource_url = \"https://www.gov.uk/government/collections/drug-misuse-declared\",\n\tsource_title = \"Crime Survey for England and Wales, 2019\"\n)\n```\n\n```{r get and tidy data}\nif (!file.exists(paste0(chart_details$id, \"-data.csv.gz\"))) {\n\t\n\t# download data\n\tdata_file <- tempfile(fileext = \".xlsx\")\n\tGET(\"https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/832332/drug-misuse-1819-tables.xlsx\", write_disk(data_file))\n\t\n\t# read data\n\t# data for young people is in a separate sheet to data for all adults, so the\n\t# two sheets are read separately and then merged\n\tfile_data <- list(\n\t\t\"16–59 years\" = read_excel(data_file, sheet = \"1.02\", skip = 3, na = \"n/a\"),\n\t\t\"16–24 years\" = read_excel(data_file, sheet = \"1.06\", skip = 3, na = \"n/a\")\n\t)\n\t\n\t# tidy data\n\ttidy_data <- file_data %>% map(function (x) {\n\t\tx %>% \n\t\t\t# unusually, we will not clean_names() at this point because we are going\n\t\t\t# to gather the columns later, although we can still rename the first \n\t\t\t# column\n\t\t\trename(drug_type = `...1`) %>%\n\t\t\t# remove blank rows below header and footnotes below data\n\t\t\tslice(3:33, 35) %>% \n\t\t\t# remove trailing columns showing significance, etc.\n\t\t\tselect(1:22) %>% \n\t\t\t# remove blank columns\n\t\t\tfilter_all(all_vars(!is.na(.))) %>% \n\t\t\t# strip footnote markers from drug_type\n\t\t\tmutate(drug_type = str_remove(drug_type, \"\\\\d+$\")) %>% \n\t\t\t# gather the years of data into long format\n\t\t\tgather(key = \"period\", value = \"estimate\", -drug_type) %>% \n\t\t\t# replace 'n/a' strings with NA, which allows us convert estimate to \n\t\t\t# numeric, converting percentages to proportions at the same time\n\t\t\tmutate(estimate = ifelse(estimate == \"n/a\", NA, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t as.numeric(estimate) / 100)) %>% \n\t\t\t# extract year from period description\n\t\t\tmutate(\n\t\t\t\tyear = ymd(paste0(str_sub(period, 0, 4), \"-01-01\"))\n\t\t\t)\n\t}) %>% \n\t\tbind_rows(.id = \"age_group\")\n\t\n\t# save tidy data\n\twrite_csv(tidy_data, paste0(chart_details$id, \"-data.csv.gz\"))\t\n\t\n} else {\n\t\n\t# load tidy data\n\ttidy_data <- read_csv(paste0(chart_details$id, \"-data.csv.gz\"))\n\t\n}\n```\n\n```{r prepare data for chart}\nchart_data <- tidy_data %>% \n\t# select data wanted for chart\n\tfilter(\n\t\tdrug_type %in% c(\"Any cocaine\", \"Ecstasy\", \"Hallucinogens\", \"Amphetamines\", \n\t\t\t\t\t\t\t\t\t\t \"Cannabis\", \"Heroin\", \"Any drug\"),\n\t\tyear >= max(year) - years(20)\n\t) %>% \n\t# change category names for display\n\tmutate(\n\t\tdrug_type = str_to_lower(drug_type),\n\t\tdrug_type = recode(\n\t\t\tdrug_type,\n\t\t\t\"any drug\" = \"any illegal drug\",\n\t\t\t\"amphetamines\" = \"amphetamines (5th)\",\n\t\t\t\"cannabis\" = \"cannabis (6th)\",\n\t\t\t\"any cocaine\" = \"cocaine (4th)\",\n\t\t\t\"ecstasy\" = \"ecstasy (15th)\",\n\t\t\t\"hallucinogens\" = \"LSD/magic mushrooms (16th)\",\n\t\t\t\"heroin\" = \"heroin (1st)\"\n\t\t)\n\t)\n\nmean_data <- chart_data %>% \n\tfilter(age_group == \"16–59 years\") %>% \n\tgroup_by(drug_type) %>% \n\tsummarise(mean_estimate = mean(estimate, na.rm = TRUE)) %>% \n\tarrange(desc(mean_estimate))\n\nchart_data <- chart_data %>% \n\tleft_join(mean_data, by = \"drug_type\") %>% \n\tmutate(drug_type = fct_reorder(drug_type, mean_estimate, .desc = TRUE)) %>% \n\tremove_missing(na.rm = TRUE)\n\nperc_change <- chart_data %>% \n\tfilter(\n\t\tdrug_type %in% c(\"cocaine (4th)\", \"ecstasy (15th)\", \"cannabis (6th)\", \n\t\t\t\t\t\t\t\t\t\t \"LSD/magic mushrooms (16th)\", \"any illegal drug\"),\n\t\tage_group == \"16–24 years\"\n\t) %>% \n\tgroup_by(drug_type, age_group) %>% \n\tsummarise(\n\t\tsome_estimate_ago = nth(estimate, -7),\n\t\tlast_estimate = last(estimate),\n\t\tsome_years_ago = nth(year, -7),\n\t\tlast_year = last(year),\n\t\tchange = (last(estimate) - nth(estimate, -7)) / nth(estimate, -7),\n\t\tlabel = sprintf(\"%+.0f%%\", change * 100)\n\t)\n\n# add chart labels\nchart_labels <- tribble(\n\t~x, ~y, ~xend, ~yend, ~drug_type, ~label, ~hjust, ~vjust, ~curve,\n\tymd(\"2004-06-01\"), 0.28, ymd(\"2011-01-01\"), 0.30, \"any illegal drug\", balance_lines(\"compared to all adults, people aged 16–24 years are twice as likely to report using illegal drugs\", 2), \"left\", \"center\", \"left\",\n\tymd(\"2013-01-01\"), 0.1, ymd(\"2016-01-01\"), 0.13, \"cocaine (4th)\", balance_lines(\"cocaine use among young adults has doubled since 2012 while being largely stable for older adults\", 4), \"left\", \"bottom\", \"left\",\n\tymd(\"2008-01-01\"), 0.32, ymd(\"2011-01-01\"), 0.29, \"amphetamines (5th)\", balance_lines(\"rank of relative harm caused by different drugs, according to Nutt et al. 2010\", 3), \"left\", \"top\", \"right\",\n\tymd(\"2017-01-01\"), 0.01, ymd(\"2012-01-01\"), 0.1, \"heroin (1st)\", balance_lines(\"<0.1% of adults reported using heroin in the past year, which is likely to be an underestimate because the Crime Survey does not cover people living in places like hostels or prisons\", 6), \"right\", \"bottom\", \"right\"\n\t# ymd(\"\"), 60, ymd(\"\"), 70, \"\", balance_lines(\"\", 3), \"left\", \"center\", \"right\",\n) %>% \n\t# order factor levels according to order in chart data, to maintain facet and\n\t# legend order\n\tmutate(drug_type = factor(drug_type, levels = levels(chart_data$drug_type)))\n```\n\n```{r build plot}\nchart <- chart_data %>% \n  ggplot(aes(x = year, y = estimate, shape = age_group, linetype = age_group, \n  \t\t\t\t\t colour = drug_type)) + \n  geom_label(aes(x = last_year, y = last_estimate, colour = drug_type, \n  \t\t\t\t\t\t\t label = label), \n  \t\t\t\t\tdata = perc_change, size = elements$label_text_size,\n            hjust = \"right\", vjust = \"center\", nudge_y = 0.03,\n  \t\t\t\t\tlabel.size = 0) +\n\t# geom_area(aes(fill = drug_type), \n\t# \t\t\t\t\tdata = filter(chart_data, age_group == \"16–24 years\"), alpha = 0.5, \n\t# \t\t\t\t\tcolour = NA) +\n\tgeom_area(aes(fill = drug_type), \n\t\t\t\t\t\tdata = filter(chart_data, age_group == \"16–59 years\"), \n\t\t\t\t\t\tcolour = NA, alpha = 0.67, key_glyph = \"path\") +\n\tgeom_line(size = 0.75) +\n\tgeom_segment(aes(x = some_years_ago, xend = last_year, y = some_estimate_ago, \n\t\t\t\t\t\t\t\t\t yend = last_estimate, colour = drug_type), \n\t\t\t\t\t\t\t data = perc_change, linetype = \"solid\", \n\t\t\t\t\t\t\t arrow = arrow(length = unit(4, \"points\")), \n\t\t\t\t\t\t\t position = position_nudge(y = 0.02), show.legend = FALSE) + \n\t# add explanatory labels\n\tgeom_curve(aes(x = x, y = y, xend = xend, yend = yend),\n\t\t\t\t\t\t data = filter(chart_labels, curve == \"right\"), inherit.aes = FALSE, \n\t\t\t\t\t\t curvature = elements$label_line_curvature, \n\t\t\t\t\t\t colour = elements$label_line_colour, \n\t\t\t\t\t\t arrow = elements$label_arrow, show.legend = FALSE) +\n\tgeom_segment(aes(x = x, y = y, xend = xend, yend = yend),\n\t\t\t\t\t\t data = filter(chart_labels, curve == \"straight\"), \n\t\t\t\t\t\t inherit.aes = FALSE, colour = elements$label_line_colour, \n\t\t\t\t\t\t arrow = elements$label_arrow, show.legend = FALSE) +\n\tgeom_curve(aes(x = x, y = y, xend = xend, yend = yend),\n\t\t\t\t\t\t data = filter(chart_labels, curve == \"left\"), inherit.aes = FALSE, \n\t\t\t\t\t\t curvature = elements$label_line_curvature * -1, \n\t\t\t\t\t\t colour = elements$label_line_colour, \n\t\t\t\t\t\t arrow = elements$label_arrow, show.legend = FALSE) +\n\tgeom_label(aes(x = xend, y = yend, label = label, hjust = hjust, \n\t\t\t\t\t\t\t\t vjust = vjust),\n\t\t\t\t\t\tdata = chart_labels, inherit.aes = FALSE, \n\t\t\t\t\t\tcolour = elements$label_text_colour,\n\t\t\t\t\t\tfill = elements$label_text_fill, size = elements$label_text_size, \n\t\t\t\t\t\tlineheight = elements$label_text_lineheight,\n\t\t\t\t\t\tlabel.size = NA, show.legend = FALSE) +\n\t# end of explanatory labels\n\tscale_x_date(date_breaks = \"5 years\", date_labels = \"'%y\") +\n  scale_y_continuous(limits = c(0, NA), expand = c(0, 0),\n  \t\t\t\t\t\t\t\t\t labels = scales::percent_format(accuracy = 1)) +\n  scale_colour_manual(\n    values = unname(ucl_colours_list[c(\"Orange\", \"Bright Blue\", \"Bright Pink\",\n                                       \"Bright Green\", \"Bright Red\", \n                                       \"Light Blue\", \"Yellow\", \"Mid Green\")]),\n    aesthetics = c(\"colour\", \"fill\"),\n    guide = \"none\"\n  ) +\n\tscale_linetype_manual(\n\t\tvalues = rev(elements$linetype[1:2]), \n\t\tguide = guide_legend(\n\t\t\toverride.aes = list(colour = elements$label_line_colour)\n\t\t)\n\t) + \n\tscale_shape_manual(values = c(16, 1), guide = \"none\") + \n\tcoord_cartesian(clip = \"off\") +\n  facet_grid(cols = vars(drug_type), labeller = label_wrap_gen(width = 12)) +\n  labs(\n    title = chart_details$title,\n    subtitle = format_subtitle(chart_details$subtitle),\n    x = NULL,\n    y = \"people who have used drugs in the past year\",\n    linetype = NULL\n  ) +\n\ttheme_cjcharts() +\n\ttheme(\n\t\taxis.line.x = element_line(colour = \"grey80\"),\n\t\tpanel.grid = element_blank()\n\t)\n```\n\n`r chart_details$subtitle`\n\n```{r display plot, echo=FALSE, include=TRUE}\nadd_logo(chart + labs(title = NULL, subtitle = NULL), \n\t\t\t\t chart_details$source_title, chart_details$id)\n```\n\n[larger image](../`r chart_details$id`.png)\n| [annotated R code to produce this chart](https://github.com/mpjashby/lesscrime.info/blob/master/content/post/`r chart_details$id`.Rmd)\n\nData source: [`r chart_details$source_title`](`r chart_details$source_url`)\n\n```{r export chart}\n# save PNG for social media\nggsave(\n\tfilename = paste0(chart_details$id, \".png\"), \n\tplot = add_logo(chart, chart_details$source_title, chart_details$id), \n\tdevice = \"png\", width = 600 / 72, height = 400 / 72, units = \"in\"\n)\n```\n","srcMarkdownNoYaml":"\n\n```{r set knitr options, include=FALSE}\nknitr::opts_chunk$set(cache = TRUE, include=FALSE)\n```\n\n```{r load packages and helper}\n# custom packages not loaded by helpers.R\nlibrary(\"lubridate\")\nlibrary(\"readxl\")\n\n# load this after loading custom packages\nsource(here::here(\"helpers.R\"))\n```\n\n```{r set chart parameters}\nchart_details <- list(\n\tid = \"drug-use\",\n\ttitle = \"After falls, drug use by young adults is on the rise\",\n\tsubtitle = \"Self-reported drug use has fallen for most of the past 20 years according to the Crime Survey for England and Wales, but in the past seven years the use of cannabis, cocaine and ecstasy has increased substantially, particularly among people aged 16–24. However, drug use is still lower now than it was at the turn of the millenium, with about 10% of adults saying they've used an illegal drug in the past year.\",\n\tsource_url = \"https://www.gov.uk/government/collections/drug-misuse-declared\",\n\tsource_title = \"Crime Survey for England and Wales, 2019\"\n)\n```\n\n```{r get and tidy data}\nif (!file.exists(paste0(chart_details$id, \"-data.csv.gz\"))) {\n\t\n\t# download data\n\tdata_file <- tempfile(fileext = \".xlsx\")\n\tGET(\"https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/832332/drug-misuse-1819-tables.xlsx\", write_disk(data_file))\n\t\n\t# read data\n\t# data for young people is in a separate sheet to data for all adults, so the\n\t# two sheets are read separately and then merged\n\tfile_data <- list(\n\t\t\"16–59 years\" = read_excel(data_file, sheet = \"1.02\", skip = 3, na = \"n/a\"),\n\t\t\"16–24 years\" = read_excel(data_file, sheet = \"1.06\", skip = 3, na = \"n/a\")\n\t)\n\t\n\t# tidy data\n\ttidy_data <- file_data %>% map(function (x) {\n\t\tx %>% \n\t\t\t# unusually, we will not clean_names() at this point because we are going\n\t\t\t# to gather the columns later, although we can still rename the first \n\t\t\t# column\n\t\t\trename(drug_type = `...1`) %>%\n\t\t\t# remove blank rows below header and footnotes below data\n\t\t\tslice(3:33, 35) %>% \n\t\t\t# remove trailing columns showing significance, etc.\n\t\t\tselect(1:22) %>% \n\t\t\t# remove blank columns\n\t\t\tfilter_all(all_vars(!is.na(.))) %>% \n\t\t\t# strip footnote markers from drug_type\n\t\t\tmutate(drug_type = str_remove(drug_type, \"\\\\d+$\")) %>% \n\t\t\t# gather the years of data into long format\n\t\t\tgather(key = \"period\", value = \"estimate\", -drug_type) %>% \n\t\t\t# replace 'n/a' strings with NA, which allows us convert estimate to \n\t\t\t# numeric, converting percentages to proportions at the same time\n\t\t\tmutate(estimate = ifelse(estimate == \"n/a\", NA, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t as.numeric(estimate) / 100)) %>% \n\t\t\t# extract year from period description\n\t\t\tmutate(\n\t\t\t\tyear = ymd(paste0(str_sub(period, 0, 4), \"-01-01\"))\n\t\t\t)\n\t}) %>% \n\t\tbind_rows(.id = \"age_group\")\n\t\n\t# save tidy data\n\twrite_csv(tidy_data, paste0(chart_details$id, \"-data.csv.gz\"))\t\n\t\n} else {\n\t\n\t# load tidy data\n\ttidy_data <- read_csv(paste0(chart_details$id, \"-data.csv.gz\"))\n\t\n}\n```\n\n```{r prepare data for chart}\nchart_data <- tidy_data %>% \n\t# select data wanted for chart\n\tfilter(\n\t\tdrug_type %in% c(\"Any cocaine\", \"Ecstasy\", \"Hallucinogens\", \"Amphetamines\", \n\t\t\t\t\t\t\t\t\t\t \"Cannabis\", \"Heroin\", \"Any drug\"),\n\t\tyear >= max(year) - years(20)\n\t) %>% \n\t# change category names for display\n\tmutate(\n\t\tdrug_type = str_to_lower(drug_type),\n\t\tdrug_type = recode(\n\t\t\tdrug_type,\n\t\t\t\"any drug\" = \"any illegal drug\",\n\t\t\t\"amphetamines\" = \"amphetamines (5th)\",\n\t\t\t\"cannabis\" = \"cannabis (6th)\",\n\t\t\t\"any cocaine\" = \"cocaine (4th)\",\n\t\t\t\"ecstasy\" = \"ecstasy (15th)\",\n\t\t\t\"hallucinogens\" = \"LSD/magic mushrooms (16th)\",\n\t\t\t\"heroin\" = \"heroin (1st)\"\n\t\t)\n\t)\n\nmean_data <- chart_data %>% \n\tfilter(age_group == \"16–59 years\") %>% \n\tgroup_by(drug_type) %>% \n\tsummarise(mean_estimate = mean(estimate, na.rm = TRUE)) %>% \n\tarrange(desc(mean_estimate))\n\nchart_data <- chart_data %>% \n\tleft_join(mean_data, by = \"drug_type\") %>% \n\tmutate(drug_type = fct_reorder(drug_type, mean_estimate, .desc = TRUE)) %>% \n\tremove_missing(na.rm = TRUE)\n\nperc_change <- chart_data %>% \n\tfilter(\n\t\tdrug_type %in% c(\"cocaine (4th)\", \"ecstasy (15th)\", \"cannabis (6th)\", \n\t\t\t\t\t\t\t\t\t\t \"LSD/magic mushrooms (16th)\", \"any illegal drug\"),\n\t\tage_group == \"16–24 years\"\n\t) %>% \n\tgroup_by(drug_type, age_group) %>% \n\tsummarise(\n\t\tsome_estimate_ago = nth(estimate, -7),\n\t\tlast_estimate = last(estimate),\n\t\tsome_years_ago = nth(year, -7),\n\t\tlast_year = last(year),\n\t\tchange = (last(estimate) - nth(estimate, -7)) / nth(estimate, -7),\n\t\tlabel = sprintf(\"%+.0f%%\", change * 100)\n\t)\n\n# add chart labels\nchart_labels <- tribble(\n\t~x, ~y, ~xend, ~yend, ~drug_type, ~label, ~hjust, ~vjust, ~curve,\n\tymd(\"2004-06-01\"), 0.28, ymd(\"2011-01-01\"), 0.30, \"any illegal drug\", balance_lines(\"compared to all adults, people aged 16–24 years are twice as likely to report using illegal drugs\", 2), \"left\", \"center\", \"left\",\n\tymd(\"2013-01-01\"), 0.1, ymd(\"2016-01-01\"), 0.13, \"cocaine (4th)\", balance_lines(\"cocaine use among young adults has doubled since 2012 while being largely stable for older adults\", 4), \"left\", \"bottom\", \"left\",\n\tymd(\"2008-01-01\"), 0.32, ymd(\"2011-01-01\"), 0.29, \"amphetamines (5th)\", balance_lines(\"rank of relative harm caused by different drugs, according to Nutt et al. 2010\", 3), \"left\", \"top\", \"right\",\n\tymd(\"2017-01-01\"), 0.01, ymd(\"2012-01-01\"), 0.1, \"heroin (1st)\", balance_lines(\"<0.1% of adults reported using heroin in the past year, which is likely to be an underestimate because the Crime Survey does not cover people living in places like hostels or prisons\", 6), \"right\", \"bottom\", \"right\"\n\t# ymd(\"\"), 60, ymd(\"\"), 70, \"\", balance_lines(\"\", 3), \"left\", \"center\", \"right\",\n) %>% \n\t# order factor levels according to order in chart data, to maintain facet and\n\t# legend order\n\tmutate(drug_type = factor(drug_type, levels = levels(chart_data$drug_type)))\n```\n\n```{r build plot}\nchart <- chart_data %>% \n  ggplot(aes(x = year, y = estimate, shape = age_group, linetype = age_group, \n  \t\t\t\t\t colour = drug_type)) + \n  geom_label(aes(x = last_year, y = last_estimate, colour = drug_type, \n  \t\t\t\t\t\t\t label = label), \n  \t\t\t\t\tdata = perc_change, size = elements$label_text_size,\n            hjust = \"right\", vjust = \"center\", nudge_y = 0.03,\n  \t\t\t\t\tlabel.size = 0) +\n\t# geom_area(aes(fill = drug_type), \n\t# \t\t\t\t\tdata = filter(chart_data, age_group == \"16–24 years\"), alpha = 0.5, \n\t# \t\t\t\t\tcolour = NA) +\n\tgeom_area(aes(fill = drug_type), \n\t\t\t\t\t\tdata = filter(chart_data, age_group == \"16–59 years\"), \n\t\t\t\t\t\tcolour = NA, alpha = 0.67, key_glyph = \"path\") +\n\tgeom_line(size = 0.75) +\n\tgeom_segment(aes(x = some_years_ago, xend = last_year, y = some_estimate_ago, \n\t\t\t\t\t\t\t\t\t yend = last_estimate, colour = drug_type), \n\t\t\t\t\t\t\t data = perc_change, linetype = \"solid\", \n\t\t\t\t\t\t\t arrow = arrow(length = unit(4, \"points\")), \n\t\t\t\t\t\t\t position = position_nudge(y = 0.02), show.legend = FALSE) + \n\t# add explanatory labels\n\tgeom_curve(aes(x = x, y = y, xend = xend, yend = yend),\n\t\t\t\t\t\t data = filter(chart_labels, curve == \"right\"), inherit.aes = FALSE, \n\t\t\t\t\t\t curvature = elements$label_line_curvature, \n\t\t\t\t\t\t colour = elements$label_line_colour, \n\t\t\t\t\t\t arrow = elements$label_arrow, show.legend = FALSE) +\n\tgeom_segment(aes(x = x, y = y, xend = xend, yend = yend),\n\t\t\t\t\t\t data = filter(chart_labels, curve == \"straight\"), \n\t\t\t\t\t\t inherit.aes = FALSE, colour = elements$label_line_colour, \n\t\t\t\t\t\t arrow = elements$label_arrow, show.legend = FALSE) +\n\tgeom_curve(aes(x = x, y = y, xend = xend, yend = yend),\n\t\t\t\t\t\t data = filter(chart_labels, curve == \"left\"), inherit.aes = FALSE, \n\t\t\t\t\t\t curvature = elements$label_line_curvature * -1, \n\t\t\t\t\t\t colour = elements$label_line_colour, \n\t\t\t\t\t\t arrow = elements$label_arrow, show.legend = FALSE) +\n\tgeom_label(aes(x = xend, y = yend, label = label, hjust = hjust, \n\t\t\t\t\t\t\t\t vjust = vjust),\n\t\t\t\t\t\tdata = chart_labels, inherit.aes = FALSE, \n\t\t\t\t\t\tcolour = elements$label_text_colour,\n\t\t\t\t\t\tfill = elements$label_text_fill, size = elements$label_text_size, \n\t\t\t\t\t\tlineheight = elements$label_text_lineheight,\n\t\t\t\t\t\tlabel.size = NA, show.legend = FALSE) +\n\t# end of explanatory labels\n\tscale_x_date(date_breaks = \"5 years\", date_labels = \"'%y\") +\n  scale_y_continuous(limits = c(0, NA), expand = c(0, 0),\n  \t\t\t\t\t\t\t\t\t labels = scales::percent_format(accuracy = 1)) +\n  scale_colour_manual(\n    values = unname(ucl_colours_list[c(\"Orange\", \"Bright Blue\", \"Bright Pink\",\n                                       \"Bright Green\", \"Bright Red\", \n                                       \"Light Blue\", \"Yellow\", \"Mid Green\")]),\n    aesthetics = c(\"colour\", \"fill\"),\n    guide = \"none\"\n  ) +\n\tscale_linetype_manual(\n\t\tvalues = rev(elements$linetype[1:2]), \n\t\tguide = guide_legend(\n\t\t\toverride.aes = list(colour = elements$label_line_colour)\n\t\t)\n\t) + \n\tscale_shape_manual(values = c(16, 1), guide = \"none\") + \n\tcoord_cartesian(clip = \"off\") +\n  facet_grid(cols = vars(drug_type), labeller = label_wrap_gen(width = 12)) +\n  labs(\n    title = chart_details$title,\n    subtitle = format_subtitle(chart_details$subtitle),\n    x = NULL,\n    y = \"people who have used drugs in the past year\",\n    linetype = NULL\n  ) +\n\ttheme_cjcharts() +\n\ttheme(\n\t\taxis.line.x = element_line(colour = \"grey80\"),\n\t\tpanel.grid = element_blank()\n\t)\n```\n\n`r chart_details$subtitle`\n\n```{r display plot, echo=FALSE, include=TRUE}\nadd_logo(chart + labs(title = NULL, subtitle = NULL), \n\t\t\t\t chart_details$source_title, chart_details$id)\n```\n\n[larger image](../`r chart_details$id`.png)\n| [annotated R code to produce this chart](https://github.com/mpjashby/lesscrime.info/blob/master/content/post/`r chart_details$id`.Rmd)\n\nData source: [`r chart_details$source_title`](`r chart_details$source_url`)\n\n```{r export chart}\n# save PNG for social media\nggsave(\n\tfilename = paste0(chart_details$id, \".png\"), \n\tplot = add_logo(chart, chart_details$source_title, chart_details$id), \n\tdevice = \"png\", width = 600 / 72, height = 400 / 72, units = \"in\"\n)\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.57","author":[{"name":"Matt Ashby"},"Matt Ashby"],"theme":["sandstone","../../custom.scss"],"date-format":"D MMM YYYY","title":"Chart: Drug use was falling, but that seems to be changing","date":"2019-09-23","categories":["Crime and justice chart of the week"],"tags":["crime","CSEW","drugs"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}